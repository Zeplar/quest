<!DOCTYPE html>
<html>
<head>
  <title>Collaborative Drawing App</title>
  <style>
    #canvas {
      border: 1px solid #000;
    }
  </style>
</head>
<body>
  <canvas id="canvas"
          width="480"
          height="360">
  </canvas>
    <label for="favcolor">Select your favorite color:</label>
    <input type="color" id="favcolor" name="favcolor" value="#ff0000">
  <div>
    <button id="clearButton">Clear</button>
    <button id="undoButton">Undo</buton>
  </div>
  <script>
    MESSAGE_CONNECTED = 1;
    MESSAGE_STROKE = 2;
    MESSAGE_CLEAR = 3;
    MESSAGE_UNDO = 4;

    var strokes = [];
    var strokeID = 0;
    var shapeID = 0;
    var strokeColor = 'red';
    var ownerID = 0;
    var currentStroke = new Stroke()

    function Stroke() {
        this.color = strokeColor;
        this.points = [];
        this.shapeID = ++shapeID;
        this.strokeID = ++strokeID;
        this.ownerID = ownerID;
    }
    window.onload = function () {
        var canvas = document.getElementById('canvas');
        var ctx = canvas.getContext("2d");
        var isDrawing = false;

        var socket = new WebSocket("ws://192.168.1.126:3000/ws");

        document.getElementById("favcolor").onchange = function() {
            strokeColor = this.value;
            currentStroke.color = strokeColor;
            update();
        }

        canvas.onmousedown = function (event) {
            currentStroke = new Stroke()
            isDrawing = true;
            addPoint(event.pageX - this.offsetLeft, event.pageY - this.offsetTop, true);
        };

        canvas.onmousemove = function (event) {
            if (isDrawing) {
                addPoint(event.pageX - this.offsetLeft, event.pageY - this.offsetTop);
                update();
            }
        };

        canvas.onmouseup = function () {
            isDrawing = false;
            socket.send(JSON.stringify({ kind: MESSAGE_STROKE, stroke: currentStroke }));
        };

        canvas.onmouseleave = function () {
            isDrawing = false;
        };
        function addPoint(x, y, newStroke) {
            var p = { x: x, y: y };
            currentStroke.points.push(p);
        }

        function update() {
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            ctx.lineJoin = 'round';
            ctx.lineWidth = 4;

            for (var i = 0; i < strokes.length; i++) {
                drawStroke(strokes[i]);
            }
            drawStroke(currentStroke);
        }
        function drawStroke(stroke) {
            ctx.strokeStyle = stroke.color
            ctx.moveTo(stroke.points[0], stroke.points[1])
            ctx.beginPath();
            for (var i = 1; i < stroke.points.length; i++) {
                var current = stroke.points[i];
                ctx.lineTo(current.x, current.y);
            }
            // ctx.closePath();
            ctx.stroke();
        }
        document.getElementById('clearButton').onclick = function () {
            socket.send(JSON.stringify({ kind: MESSAGE_CLEAR }));
        };

        document.getElementById('undoButton').onclick = function () {
            socket.send(JSON.stringify({ kind: MESSAGE_UNDO, stroke: {strokeID: strokeID, ownerID: ownerID}}))
        };

        socket.onmessage = function (event) {
            var messages = event.data.split('\n');
            for (var i = 0; i < messages.length; i++) {
                var message = JSON.parse(messages[i]);
                onMessage(message);
            }
        };

        // remove deletes a stroke from the global array.
        function remove(s) {
            for (var i = 0; i < strokes.length; i++) {
                stroke = strokes[i]
                if (stroke.ownerID != s.ownerID || stroke.strokeID != s.strokeID ){
                    continue;
                }
                strokes.splice(i, 1);
                // Adjust local strokeID if we removed one of our own strokes
                if (s.ownerID == ownerID && s.strokeID == strokeID) {
                    strokeID--;
                }
                return;
            }
            console.log("Could not find stroke");
        }

        function onMessage(message) {
            switch (message.kind) {
                case MESSAGE_CONNECTED:
                    ownerID = message.stroke.ownerID;
                break;
                case MESSAGE_STROKE:
                    strokes.push(message.stroke);
                break;
                case MESSAGE_CLEAR:
                    strokes = [];
                break;
                case MESSAGE_UNDO:
                    remove(message.stroke);
                break;
            }
            update();
        }
    }
    
  </script>
</body>
</html>